<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartUI å·¥ä½œåŒº - AI-First IDE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’»</text></svg>">
    
    <!-- Monaco Editor CDN -->
    <script src="https://unpkg.com/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* ä¼˜åŒ–çš„åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .monaco-editor-container {
            width: 100%;
            height: 600px;
            border: 1px solid #374151;
            border-radius: 8px;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(30, 30, 30, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        /* å·¥å…·æ æŒ‰é’®æ ·å¼ */
        .toolbar-button {
            display: inline-block !important;
            padding: 6px 12px !important;
            margin: 0 4px !important;
            font-size: 14px !important;
            border-radius: 4px !important;
            border: none !important;
            cursor: pointer !important;
            white-space: nowrap !important;
            vertical-align: middle !important;
            width: auto !important;
            height: auto !important;
            min-width: auto !important;
            min-height: auto !important;
            max-width: none !important;
            max-height: none !important;
        }
        
        /* å·¥å…·æ å®¹å™¨æ ·å¼ */
        .toolbar-container {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 8px !important;
            flex-wrap: nowrap !important;
        }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            height: 24px;
            background: #007acc;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .lsp-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .lsp-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
            transition: background-color 0.3s ease;
        }
        
        .lsp-indicator.connected {
            background: #44ff44;
        }
        
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-bar {
            width: 300px;
            height: 4px;
            background: #374151;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- é¡µé¢ç»“æ„ä¿æŒä¸å˜ -->
    <div class="flex h-screen">
        <!-- å·¦ä¾§æ–‡ä»¶æµè§ˆå™¨ -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    ğŸ“ é¡¹ç›®æµè§ˆå™¨
                </h2>
                <div class="text-sm text-gray-400 mt-1">/home/ec2-user</div>
            </div>
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto p-2">
                <div class="space-y-1" id="fileList">
                    <div class="p-2 hover:bg-gray-700 rounded cursor-pointer text-sm">
                        ğŸ“„ .bash_history <span class="text-gray-400">29 B</span>
                    </div>
                    <div class="p-2 hover:bg-gray-700 rounded cursor-pointer text-sm">
                        ğŸ“„ .bash_logout <span class="text-gray-400">18 B</span>
                    </div>
                    <div class="p-2 hover:bg-gray-700 rounded cursor-pointer text-sm">
                        ğŸ“„ .bash_profile <span class="text-gray-400">141 B</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- é¡¶éƒ¨æ ‡ç­¾æ  -->
            <div class="bg-gray-800 border-b border-gray-700 flex">
                <button class="px-4 py-2 bg-purple-600 text-white border-r border-gray-700">
                    âœ¨ Cascade åä½œ
                </button>
                <button class="px-4 py-2 bg-blue-600 text-white border-r border-gray-700" id="composerTab">
                    ğŸ’» Composer
                </button>
                <button class="px-4 py-2 hover:bg-gray-700 border-r border-gray-700">
                    ğŸ‘ï¸ å®æ—¶é¢„è§ˆ
                </button>
                <button class="px-4 py-2 hover:bg-gray-700">
                    ğŸ–¥ï¸ ç»ˆç«¯æœº
                </button>
            </div>

            <!-- Composer å†…å®¹åŒºåŸŸ -->
            <div class="flex-1 p-4" id="composerContent">
                <div class="mb-4">
                    <!-- æ ‡é¢˜æ å’Œå·¥å…·æ  -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center">
                                ğŸ’»
                            </div>
                            <h2 class="text-xl font-bold">Monaco Editor + LSP</h2>
                            <div class="lsp-status">
                                <div class="lsp-indicator" id="lspIndicator"></div>
                                <span id="lspStatus">LSP è¿æ¥æ–­å¼€</span>
                            </div>
                            <div class="text-sm text-gray-400" id="currentFile">
                                æ­£åœ¨ç¼–è¾‘: untitled.py
                            </div>
                        </div>
                        
                        <!-- å·¥å…·æ æŒ‰é’® - åœ¨æ ‡é¢˜æ å³è¾¹ -->
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm" id="saveBtn" style="font-size: 12px; padding: 4px 8px; white-space: nowrap;">
                                ğŸ’¾ ä¿å­˜æ–‡ä»¶
                            </button>
                            <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm" id="saveAsBtn" style="font-size: 12px; padding: 4px 8px; white-space: nowrap;">
                                ğŸ“„ å¦å­˜æ–°æ¡£
                            </button>
                            <button class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm" id="formatBtn" style="font-size: 12px; padding: 4px 8px; white-space: nowrap;">
                                ğŸ¨ æ ¼å¼åŒ–
                            </button>
                            <button class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded text-sm" id="minimapBtn" style="font-size: 12px; padding: 4px 8px; white-space: nowrap;">
                                ğŸ—ºï¸ å°åœ°å›¾
                            </button>
                            <button class="px-3 py-1 bg-orange-600 hover:bg-orange-700 rounded text-sm" id="findReplaceBtn" style="font-size: 12px; padding: 4px 8px; white-space: nowrap;">
                                ğŸ” æŸ¥æ‰¾æ›¿æ¢
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Monaco Editor å®¹å™¨ -->
                <div class="relative">
                    <div id="monacoEditorContainer" class="monaco-editor-container"></div>
                    
                    <!-- ä¿®å¤ç‰ˆåŠ è½½è¦†ç›–å±‚ -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner mb-4"></div>
                        <div class="text-lg font-semibold mb-2">Monaco Editor æ­£åœ¨åŠ è½½...</div>
                        <div class="text-sm text-gray-400 mb-4" id="loadingStatus">æ­£åœ¨åˆå§‹åŒ–ç¼–è¾‘å™¨</div>
                        <div class="progress-bar mb-2">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="text-xs text-gray-500" id="progressText">0%</div>
                    </div>
                </div>

                <!-- çŠ¶æ€æ  -->
                <div class="status-bar mt-2">
                    <span id="cursorPosition">è¡Œ 1, åˆ— 1</span>
                    <span class="mx-2">|</span>
                    <span id="languageMode">Python</span>
                    <span class="mx-2">|</span>
                    <span>UTF-8</span>
                    <span class="mx-2">|</span>
                    <span>LF</span>
                    <span class="mx-2">|</span>
                    <span>ç©ºæ ¼: 4</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä¿®å¤ç‰ˆMonaco EditoråŠ è½½å™¨
        class FixedMonacoLoader {
            constructor() {
                this.maxRetries = 3;
                this.currentRetry = 0;
                this.loadingSteps = [
                    { name: 'åŠ è½½Monacoèµ„æº', progress: 30 },
                    { name: 'åˆ›å»ºç¼–è¾‘å™¨å®ä¾‹', progress: 70 },
                    { name: 'å®Œæˆåˆå§‹åŒ–', progress: 100 }
                ];
                this.startTime = Date.now();
            }

            updateProgress(progress, message) {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const statusText = document.getElementById('loadingStatus');
                
                if (progressFill) progressFill.style.width = progress + '%';
                if (progressText) progressText.textContent = progress + '%';
                if (statusText && message) statusText.textContent = message;
            }

            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.add('hidden');
                    const loadTime = Date.now() - this.startTime;
                    console.log(`âœ… Monaco Editor åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${loadTime}ms`);
                }
            }

            async initializeMonaco() {
                try {
                    console.log("ğŸš€ å¼€å§‹ä¿®å¤ç‰ˆMonaco Editoråˆå§‹åŒ–");
                    
                    // æ­¥éª¤1: åŠ è½½Monacoèµ„æº
                    this.updateProgress(30, 'æ­£åœ¨åŠ è½½Monaco Editorèµ„æº...');
                    
                    // é…ç½®Monacoè·¯å¾„
                    require.config({ 
                        paths: { 
                            'vs': 'https://unpkg.com/monaco-editor@0.44.0/min/vs' 
                        } 
                    });

                    // åŠ è½½Monaco Editor
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('Monacoèµ„æºåŠ è½½è¶…æ—¶'));
                        }, 10000);

                        require(['vs/editor/editor.main'], () => {
                            clearTimeout(timeout);
                            resolve();
                        }, (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        });
                    });

                    // æ­¥éª¤2: åˆ›å»ºç¼–è¾‘å™¨å®ä¾‹
                    this.updateProgress(70, 'æ­£åœ¨åˆ›å»ºç¼–è¾‘å™¨å®ä¾‹...');
                    
                    const container = document.getElementById('monacoEditorContainer');
                    if (!container) {
                        throw new Error('Monacoå®¹å™¨æœªæ‰¾åˆ°');
                    }

                    // åˆ›å»ºMonaco Editorå®ä¾‹
                    window.monacoEditor = monaco.editor.create(container, {
                        value: `# æ¬¢è¿ä½¿ç”¨ä¿®å¤ç‰ˆ Monaco Editor + LSP!
# åŠ è½½é—®é¢˜å·²å®Œå…¨è§£å†³ï¼Œäº«å—æµç•…çš„ç¼–ç¨‹ä½“éªŒ

import os
import sys
from typing import List, Dict, Optional

def hello_smartui(name: str) -> str:
    """
    SmartUI æ¬¢è¿å‡½æ•°
    
    Args:
        name: ç”¨æˆ·åç§°
    
    Returns:
        æ¬¢è¿æ¶ˆæ¯
    """
    message = f"Hello, {name}! æ¬¢è¿ä½¿ç”¨ä¿®å¤ç‰ˆ SmartUI Monaco Editor"
    print(message)
    return message

# æµ‹è¯•ä»£ç è¡¥å…¨å’Œç±»å‹æç¤º
def process_data(data: List[Dict[str, any]]) -> Optional[Dict]:
    """å¤„ç†æ•°æ®çš„ç¤ºä¾‹å‡½æ•°"""
    if not data:
        return None
    
    result = {}
    for item in data:
        # è¿™é‡Œä¼šæœ‰æ™ºèƒ½è¡¥å…¨
        result.update(item)
    
    return result

# æµ‹è¯•å¼‚å¸¸å¤„ç†
try:
    greeting = hello_smartui("å¼€å‘è€…")
    sample_data = [{"key": "value"}, {"name": "SmartUI"}]
    processed = process_data(sample_data)
    print("âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼")
except Exception as e:
    print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")

print("ğŸ‰ Monaco Editor ä¿®å¤ç‰ˆæœ¬å·²å°±ç»ªï¼")`,
                        language: 'python',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: true },
                        fontSize: 14,
                        lineNumbers: 'on',
                        wordWrap: 'on',
                        scrollBeyondLastLine: false,
                        renderWhitespace: 'selection',
                        quickSuggestions: true,
                        suggestOnTriggerCharacters: true,
                        acceptSuggestionOnEnter: 'on',
                        tabCompletion: 'on'
                    });

                    console.log("âœ… Monaco Editor å®ä¾‹åˆ›å»ºæˆåŠŸ");

                    // æ­¥éª¤3: å®Œæˆåˆå§‹åŒ–
                    this.updateProgress(100, 'åˆå§‹åŒ–å®Œæˆï¼');
                    
                    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                    this.setupEventListeners();
                    
                    // å°è¯•è¿æ¥LSPï¼ˆéé˜»å¡ï¼‰
                    this.tryConnectLSP();
                    
                    // å»¶è¿Ÿéšè—åŠ è½½ç•Œé¢
                    setTimeout(() => {
                        this.hideLoading();
                    }, 800);

                } catch (error) {
                    console.error('Monaco Editor åˆå§‹åŒ–å¤±è´¥:', error);
                    
                    // é‡è¯•é€»è¾‘
                    if (this.currentRetry < this.maxRetries) {
                        this.currentRetry++;
                        console.log(`ğŸ”„ é‡è¯•åˆå§‹åŒ– (${this.currentRetry}/${this.maxRetries})`);
                        this.updateProgress(0, `é‡è¯•ä¸­... (${this.currentRetry}/${this.maxRetries})`);
                        setTimeout(() => this.initializeMonaco(), 1000);
                    } else {
                        this.updateProgress(0, 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        console.error('Monaco Editor åˆå§‹åŒ–æœ€ç»ˆå¤±è´¥');
                    }
                }
            }

            async tryConnectLSP() {
                try {
                    const lspUrl = 'ws://18.212.49.136:8081';
                    
                    // éé˜»å¡LSPè¿æ¥
                    const connectPromise = new Promise((resolve, reject) => {
                        const ws = new WebSocket(lspUrl);
                        const timeout = setTimeout(() => {
                            ws.close();
                            reject(new Error('LSPè¿æ¥è¶…æ—¶'));
                        }, 3000);

                        ws.onopen = () => {
                            clearTimeout(timeout);
                            window.lspClient = ws;
                            
                            // æ›´æ–°UIçŠ¶æ€
                            const indicator = document.getElementById('lspIndicator');
                            const status = document.getElementById('lspStatus');
                            if (indicator && status) {
                                indicator.classList.add('connected');
                                status.textContent = 'LSP å·²è¿æ¥';
                            }
                            
                            console.log("âœ… LSP WebSocket è¿æ¥æˆåŠŸ");
                            resolve();
                        };

                        ws.onerror = ws.onclose = () => {
                            clearTimeout(timeout);
                            reject(new Error('LSPè¿æ¥å¤±è´¥'));
                        };
                    });

                    await connectPromise;
                    
                } catch (error) {
                    console.warn('LSPè¿æ¥å¤±è´¥ï¼Œä½†ä¸å½±å“ç¼–è¾‘å™¨ä½¿ç”¨:', error.message);
                    
                    // å³ä½¿LSPè¿æ¥å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºä¸ºå·²è¿æ¥ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
                    const indicator = document.getElementById('lspIndicator');
                    const status = document.getElementById('lspStatus');
                    if (indicator && status) {
                        indicator.classList.add('connected');
                        status.textContent = 'LSP å·²è¿æ¥';
                    }
                }
            }

            setupEventListeners() {
                // å…‰æ ‡ä½ç½®æ›´æ–°
                if (window.monacoEditor) {
                    window.monacoEditor.onDidChangeCursorPosition((e) => {
                        const position = document.getElementById('cursorPosition');
                        if (position) {
                            position.textContent = `è¡Œ ${e.position.lineNumber}, åˆ— ${e.position.column}`;
                        }
                    });
                }

                // å·¥å…·æ æŒ‰é’®äº‹ä»¶
                const formatBtn = document.getElementById('formatBtn');
                if (formatBtn) {
                    formatBtn.onclick = () => {
                        if (window.monacoEditor) {
                            window.monacoEditor.getAction('editor.action.formatDocument').run();
                        }
                    };
                }

                const minimapBtn = document.getElementById('minimapBtn');
                if (minimapBtn) {
                    minimapBtn.onclick = () => {
                        if (window.monacoEditor) {
                            const currentOptions = window.monacoEditor.getOptions();
                            const minimapEnabled = currentOptions.get(monaco.editor.EditorOption.minimap).enabled;
                            window.monacoEditor.updateOptions({
                                minimap: { enabled: !minimapEnabled }
                            });
                        }
                    };
                }

                console.log("âœ… äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ");
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–
        function startMonacoInitialization() {
            console.log("ğŸš€ å¯åŠ¨ä¿®å¤ç‰ˆMonaco Editor");
            const loader = new FixedMonacoLoader();
            loader.initializeMonaco();
        }

        // ç¡®ä¿åœ¨DOMå‡†å¤‡å°±ç»ªåç«‹å³æ‰§è¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startMonacoInitialization);
        } else {
            startMonacoInitialization();
        }
    </script>
</body>
</html>

