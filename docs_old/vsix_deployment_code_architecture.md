# VSIXéƒ¨ç½²ç³»çµ±ä»£ç¢¼æ¶æ§‹å’Œå¯¦ç¾ç´°ç¯€

## ğŸ—ï¸ **ä»£ç¢¼æ¶æ§‹ç¸½è¦½**

### **æ¨¡å¡Šä¾è³´é—œä¿‚**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VSIXéƒ¨ç½²ç³»çµ±æ¶æ§‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AICoreç«¯       â”‚    â”‚  Local MCPç«¯    â”‚    â”‚ VSCodeç«¯ â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚          â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ Deployer    â”‚ â”‚â”€â”€â”€â–¶â”‚ â”‚ Receiver    â”‚ â”‚â”€â”€â”€â–¶â”‚ â”‚ CLI  â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ Builder     â”‚ â”‚    â”‚ â”‚ Installer   â”‚ â”‚    â”‚ â”‚ Ext  â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚          â”‚ â”‚
â”‚  â”‚ â”‚ Validator   â”‚ â”‚    â”‚ â”‚ Registry    â”‚ â”‚    â”‚          â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              E2Eé©—è­‰ç³»çµ±                                â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚ â”‚ Env     â”‚ â”‚ Build   â”‚ â”‚ Deploy  â”‚ â”‚ Verify  â”‚        â”‚ â”‚
â”‚  â”‚ â”‚ Check   â”‚ â”‚ Test    â”‚ â”‚ Test    â”‚ â”‚ Test    â”‚        â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ **æ–‡ä»¶çµæ§‹å’Œè·è²¬**

### **aicore_vsix_deployer.py** (AICoreç«¯éƒ¨ç½²çµ„ä»¶)
```
aicore_vsix_deployer.py
â”œâ”€â”€ VSIXDeploymentConfig        # é…ç½®æ•¸æ“šé¡
â”œâ”€â”€ VSIXPackage                 # VSIXåŒ…ä¿¡æ¯æ•¸æ“šé¡
â”œâ”€â”€ DeploymentResult           # éƒ¨ç½²çµæœæ•¸æ“šé¡
â””â”€â”€ AICore_VSIX_Deployer       # ä¸»è¦éƒ¨ç½²å™¨é¡
    â”œâ”€â”€ __aenter__/__aexit__   # ç•°æ­¥ä¸Šä¸‹æ–‡ç®¡ç†
    â”œâ”€â”€ deploy_vsix_to_local_mcp()  # ä¸»è¦éƒ¨ç½²æ–¹æ³•
    â”œâ”€â”€ _build_vsix_package()      # VSIXæ§‹å»º
    â”œâ”€â”€ _validate_vsix_package()   # VSIXé©—è­‰
    â”œâ”€â”€ _prepare_deployment_payload()  # éƒ¨ç½²è¼‰è·æº–å‚™
    â”œâ”€â”€ _deploy_to_local_mcp()     # éƒ¨ç½²åˆ°MCP
    â”œâ”€â”€ _verify_deployment()       # éƒ¨ç½²é©—è­‰
    â”œâ”€â”€ _run_command()             # å‘½ä»¤åŸ·è¡Œ
    â”œâ”€â”€ _calculate_file_checksum() # æ ¡é©—å’Œè¨ˆç®—
    â”œâ”€â”€ _extract_vsix_metadata()   # å…ƒæ•¸æ“šæå–
    â””â”€â”€ _generate_deployment_signature()  # ç°½åç”Ÿæˆ
```

### **local_mcp_vsix_receiver.py** (Local MCPç«¯æ¥æ”¶çµ„ä»¶)
```
local_mcp_vsix_receiver.py
â”œâ”€â”€ LocalMCPConfig             # MCPé…ç½®æ•¸æ“šé¡
â”œâ”€â”€ ExtensionInfo              # æ“´å±•ä¿¡æ¯æ•¸æ“šé¡
â”œâ”€â”€ DeploymentRequest          # éƒ¨ç½²è«‹æ±‚æ•¸æ“šé¡
â”œâ”€â”€ InstallationResult         # å®‰è£çµæœæ•¸æ“šé¡
â””â”€â”€ LocalMCP_VSIX_Receiver     # ä¸»è¦æ¥æ”¶å™¨é¡
    â”œâ”€â”€ __init__()             # åˆå§‹åŒ–å’Œè·¯ç”±è¨­ç½®
    â”œâ”€â”€ _setup_routes()        # APIè·¯ç”±è¨­ç½®
    â”‚   â”œâ”€â”€ POST /api/v1/extensions/deploy     # éƒ¨ç½²ç«¯é»
    â”‚   â”œâ”€â”€ POST /api/v1/extensions/verify     # é©—è­‰ç«¯é»
    â”‚   â”œâ”€â”€ GET  /api/v1/extensions/list       # åˆ—è¡¨ç«¯é»
    â”‚   â”œâ”€â”€ DELETE /api/v1/extensions/{name}   # å¸è¼‰ç«¯é»
    â”‚   â””â”€â”€ GET  /api/v1/health               # å¥åº·æª¢æŸ¥
    â”œâ”€â”€ _process_deployment_async()  # ç•°æ­¥éƒ¨ç½²è™•ç†
    â”œâ”€â”€ _save_vsix_file()           # VSIXæ–‡ä»¶ä¿å­˜
    â”œâ”€â”€ _validate_vsix_file()       # VSIXæ–‡ä»¶é©—è­‰
    â”œâ”€â”€ _install_extension()        # æ“´å±•å®‰è£
    â”œâ”€â”€ _verify_extension_installation()  # å®‰è£é©—è­‰
    â”œâ”€â”€ _check_extension_in_vscode()      # VSCodeæª¢æŸ¥
    â””â”€â”€ _load_installed_extensions()      # æ“´å±•è¨»å†Šè¡¨ç®¡ç†
```

### **e2e_vsix_verifier.py** (ç«¯åˆ°ç«¯é©—è­‰çµ„ä»¶)
```
e2e_vsix_verifier.py
â”œâ”€â”€ VerificationConfig         # é©—è­‰é…ç½®æ•¸æ“šé¡
â”œâ”€â”€ VerificationStep           # é©—è­‰æ­¥é©Ÿæ•¸æ“šé¡
â”œâ”€â”€ E2EVerificationResult      # é©—è­‰çµæœæ•¸æ“šé¡
â””â”€â”€ E2E_VSIX_Verifier         # ä¸»è¦é©—è­‰å™¨é¡
    â”œâ”€â”€ run_full_verification()    # ä¸»è¦é©—è­‰æµç¨‹
    â”œâ”€â”€ _run_verification_step()   # æ­¥é©ŸåŸ·è¡Œæ¡†æ¶
    â”œâ”€â”€ _verify_environment()      # æ­¥é©Ÿ1: ç’°å¢ƒæª¢æŸ¥
    â”œâ”€â”€ _verify_aicore_build()     # æ­¥é©Ÿ2: æ§‹å»ºé©—è­‰
    â”œâ”€â”€ _verify_deployment()       # æ­¥é©Ÿ3: éƒ¨ç½²é©—è­‰
    â”œâ”€â”€ _verify_installation()     # æ­¥é©Ÿ4: å®‰è£é©—è­‰
    â”œâ”€â”€ _verify_vscode_functionality()  # æ­¥é©Ÿ5: åŠŸèƒ½é©—è­‰
    â”œâ”€â”€ _verify_performance()      # æ­¥é©Ÿ6: æ€§èƒ½é©—è­‰
    â””â”€â”€ _generate_recommendations() # å»ºè­°ç”Ÿæˆ
```

## ğŸ”§ **æ ¸å¿ƒå¯¦ç¾ç´°ç¯€**

### **1. ç•°æ­¥è™•ç†æ¶æ§‹**

#### **ç•°æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ¨¡å¼**
```python
class AICore_VSIX_Deployer:
    async def __aenter__(self):
        """
        åˆå§‹åŒ–ç•°æ­¥è³‡æºï¼š
        â€¢ å‰µå»ºaiohttp.ClientSession
        â€¢ è¨­ç½®è¶…æ™‚é…ç½®
        â€¢ æº–å‚™HTTPé€£æ¥æ± 
        """
        self.session = aiohttp.ClientSession(
            timeout=aiohttp.ClientTimeout(total=self.config.deployment_timeout)
        )
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        """
        æ¸…ç†ç•°æ­¥è³‡æºï¼š
        â€¢ é—œé–‰HTTPæœƒè©±
        â€¢ é‡‹æ”¾é€£æ¥æ± 
        â€¢ æ¸…ç†è‡¨æ™‚æ–‡ä»¶
        """
        if self.session:
            await self.session.close()
```

#### **ä¸¦ç™¼è™•ç†æ©Ÿåˆ¶**
```python
# Local MCPç«¯ä½¿ç”¨FastAPIçš„BackgroundTasksé€²è¡Œç•°æ­¥è™•ç†
@app.post("/api/v1/extensions/deploy")
async def deploy_extension(request: dict, background_tasks: BackgroundTasks):
    # ç«‹å³è¿”å›æ¥å—éŸ¿æ‡‰
    background_tasks.add_task(self._process_deployment_async, deployment_request)
    return {"status": "accepted", "deployment_id": deployment_request.deployment_id}

# å¾Œå°ç•°æ­¥è™•ç†å¯¦éš›å®‰è£
async def _process_deployment_async(self, request: DeploymentRequest):
    # é•·æ™‚é–“é‹è¡Œçš„å®‰è£éç¨‹
    # ä¸é˜»å¡APIéŸ¿æ‡‰
```

### **2. éŒ¯èª¤è™•ç†å’Œé‡è©¦æ©Ÿåˆ¶**

#### **åˆ†å±¤éŒ¯èª¤è™•ç†**
```python
async def deploy_vsix_to_local_mcp(self) -> DeploymentResult:
    try:
        # æ­¥é©Ÿ1: æ§‹å»ºVSIXåŒ…
        vsix_package = await self._build_vsix_package(extension_source_path)
        
        # æ­¥é©Ÿ2: é©—è­‰VSIXåŒ…
        validation_result = await self._validate_vsix_package(vsix_package)
        if not validation_result["valid"]:
            raise Exception(f"VSIXåŒ…é©—è­‰å¤±æ•—: {validation_result['errors']}")
        
        # ... å…¶ä»–æ­¥é©Ÿ
        
    except Exception as e:
        logger.error(f"VSIXéƒ¨ç½²å¤±æ•—: {e}")
        return DeploymentResult(
            success=False,
            error_message=str(e),
            # ... å…¶ä»–éŒ¯èª¤ä¿¡æ¯
        )
```

#### **é‡è©¦æ©Ÿåˆ¶å¯¦ç¾**
```python
async def _wait_for_build_completion(self, build_id: str) -> Dict[str, Any]:
    """å¸¶é‡è©¦çš„ç‹€æ…‹æª¢æŸ¥"""
    for attempt in range(self.config.retry_attempts):
        try:
            async with self.session.get(status_url, headers=headers) as response:
                if response.status == 200:
                    status_data = await response.json()
                    if status_data["status"] == "completed":
                        return status_data
                    elif status_data["status"] == "failed":
                        raise Exception(f"æ§‹å»ºå¤±æ•—: {status_data.get('error')}")
                
                # ç­‰å¾…å¾Œé‡è©¦
                await asyncio.sleep(self.config.retry_delay)
        except Exception as e:
            if attempt == self.config.retry_attempts - 1:
                raise e
            await asyncio.sleep(self.config.retry_delay)
    
    raise Exception("æ§‹å»ºè¶…æ™‚")
```

### **3. å®‰å…¨æ©Ÿåˆ¶å¯¦ç¾**

#### **APIèªè­‰**
```python
# FastAPIå®‰å…¨ä¾è³´
security = HTTPBearer()

async def verify_api_key(credentials: HTTPAuthorizationCredentials = Depends(security)):
    if credentials.credentials != self.config.api_key:
        raise HTTPException(status_code=401, detail="Invalid API key")
    return credentials.credentials

# ä½¿ç”¨èªè­‰çš„ç«¯é»
@app.post("/api/v1/extensions/deploy")
async def deploy_extension(
    request: dict,
    api_key: str = Depends(verify_api_key)
):
    # å·²èªè­‰çš„è«‹æ±‚è™•ç†
```

#### **æ–‡ä»¶å®Œæ•´æ€§é©—è­‰**
```python
async def _validate_vsix_file(self, file_path: str, request: DeploymentRequest) -> Dict[str, Any]:
    """å¤šå±¤æ¬¡æ–‡ä»¶é©—è­‰"""
    errors = []
    
    # 1. æ–‡ä»¶å­˜åœ¨æ€§æª¢æŸ¥
    if not Path(file_path).exists():
        errors.append("VSIXæ–‡ä»¶ä¸å­˜åœ¨")
    
    # 2. æ ¡é©—å’Œé©—è­‰
    actual_checksum = await self._calculate_file_checksum(file_path)
    expected_checksum = request.vsix_package.get("checksum")
    if actual_checksum != expected_checksum:
        errors.append(f"æ ¡é©—å’Œä¸åŒ¹é…: {actual_checksum} != {expected_checksum}")
    
    # 3. ZIPæ ¼å¼é©—è­‰
    try:
        with zipfile.ZipFile(file_path, 'r') as zip_file:
            zip_contents = zip_file.namelist()
            if not any('package.json' in content for content in zip_contents):
                errors.append("VSIXæ–‡ä»¶ä¸­ç¼ºå°‘package.json")
    except zipfile.BadZipFile:
        errors.append("VSIXæ–‡ä»¶æ ¼å¼ç„¡æ•ˆ")
    
    return {"valid": len(errors) == 0, "errors": errors}
```

#### **éƒ¨ç½²ç°½åæ©Ÿåˆ¶**
```python
async def _generate_deployment_signature(self, vsix_package: VSIXPackage) -> str:
    """ç”Ÿæˆéƒ¨ç½²ç°½å"""
    signature_data = f"{vsix_package.name}:{vsix_package.version}:{vsix_package.checksum}:{self.deployment_id}"
    return hashlib.sha256(signature_data.encode()).hexdigest()

async def _verify_deployment_signature(self, request: DeploymentRequest) -> bool:
    """é©—è­‰éƒ¨ç½²ç°½å"""
    expected_signature = request.security.get("signature", "")
    calculated_signature = self._calculate_signature(request)
    return expected_signature == calculated_signature
```

### **4. VSCode CLIé›†æˆ**

#### **å‘½ä»¤åŸ·è¡Œæ¡†æ¶**
```python
async def _run_command(self, cmd: List[str], cwd: Path = None) -> str:
    """å®‰å…¨çš„å‘½ä»¤åŸ·è¡Œ"""
    process = await asyncio.create_subprocess_exec(
        *cmd,
        cwd=cwd,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE
    )
    
    stdout, stderr = await process.communicate()
    
    if process.returncode != 0:
        raise Exception(f"å‘½ä»¤åŸ·è¡Œå¤±æ•—: {' '.join(cmd)}\n{stderr.decode()}")
    
    return stdout.decode()
```

#### **VSCodeæ“´å±•å®‰è£**
```python
async def _install_extension(self, vsix_file_path: str, request: DeploymentRequest) -> InstallationResult:
    """VSCodeæ“´å±•å®‰è£å¯¦ç¾"""
    installation_log = []
    
    try:
        # æ§‹å»ºå®‰è£å‘½ä»¤
        cmd = [self.config.vscode_command, "--install-extension", vsix_file_path]
        
        # åŸ·è¡Œå®‰è£
        process = await asyncio.create_subprocess_exec(
            *cmd,
            stdout=asyncio.subprocess.PIPE,
            stderr=asyncio.subprocess.PIPE
        )
        
        stdout, stderr = await process.communicate()
        
        # è¨˜éŒ„è©³ç´°æ—¥èªŒ
        installation_log.extend([
            f"å‘½ä»¤: {' '.join(cmd)}",
            f"è¿”å›ç¢¼: {process.returncode}",
            f"stdout: {stdout.decode()}",
            f"stderr: {stderr.decode()}"
        ])
        
        if process.returncode == 0:
            # å®‰è£æˆåŠŸï¼Œå‰µå»ºæ“´å±•ä¿¡æ¯
            extension_info = ExtensionInfo(
                name=request.vsix_package["name"],
                version=request.vsix_package["version"],
                install_path=self._get_extension_install_path(request.vsix_package["name"]),
                checksum=request.vsix_package["checksum"],
                install_timestamp=datetime.now(),
                source_deployment_id=request.deployment_id,
                status="installed",
                metadata=request.vsix_package.get("metadata", {})
            )
            
            return InstallationResult(
                success=True,
                extension_info=extension_info,
                installation_log=installation_log
            )
        else:
            return InstallationResult(
                success=False,
                extension_info=None,
                installation_log=installation_log,
                error_message=f"VSCodeå®‰è£å‘½ä»¤å¤±æ•—: {stderr.decode()}"
            )
            
    except Exception as e:
        installation_log.append(f"å®‰è£ç•°å¸¸: {str(e)}")
        return InstallationResult(
            success=False,
            extension_info=None,
            installation_log=installation_log,
            error_message=str(e)
        )
```

### **5. ç‹€æ…‹ç®¡ç†å’ŒæŒä¹…åŒ–**

#### **æ“´å±•è¨»å†Šè¡¨ç®¡ç†**
```python
class LocalMCP_VSIX_Receiver:
    def __init__(self, config: LocalMCPConfig):
        self.installed_extensions: Dict[str, ExtensionInfo] = {}
        self._load_installed_extensions()
    
    def _load_installed_extensions(self):
        """å¾æ–‡ä»¶åŠ è¼‰æ“´å±•è¨»å†Šè¡¨"""
        registry_file = Path(self.config.extensions_dir) / "registry.json"
        if registry_file.exists():
            try:
                with open(registry_file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    for name, ext_data in data.items():
                        # é‡å»ºExtensionInfoå°è±¡
                        ext_data['install_timestamp'] = datetime.fromisoformat(ext_data['install_timestamp'])
                        self.installed_extensions[name] = ExtensionInfo(**ext_data)
            except Exception as e:
                logger.warning(f"åŠ è¼‰æ“´å±•è¨»å†Šè¡¨å¤±æ•—: {e}")
    
    async def _save_extension_registry(self):
        """ä¿å­˜æ“´å±•è¨»å†Šè¡¨åˆ°æ–‡ä»¶"""
        registry_file = Path(self.config.extensions_dir) / "registry.json"
        try:
            data = {}
            for name, ext in self.installed_extensions.items():
                ext_dict = asdict(ext)
                # åºåˆ—åŒ–datetimeå°è±¡
                ext_dict['install_timestamp'] = ext.install_timestamp.isoformat()
                data[name] = ext_dict
            
            async with aiofiles.open(registry_file, 'w', encoding='utf-8') as f:
                await f.write(json.dumps(data, indent=2, ensure_ascii=False))
        except Exception as e:
            logger.error(f"ä¿å­˜æ“´å±•è¨»å†Šè¡¨å¤±æ•—: {e}")
```

### **6. æ€§èƒ½ç›£æ§å’ŒæŒ‡æ¨™æ”¶é›†**

#### **æ€§èƒ½æ¸¬é‡æ¡†æ¶**
```python
class E2E_VSIX_Verifier:
    async def _measure_extension_startup_time(self, extension_name: str) -> Dict[str, Any]:
        """æ¸¬é‡æ“´å±•å•Ÿå‹•æ™‚é–“"""
        start_time = time.time()
        
        # å•Ÿå‹•VSCodeä¸¦æ¿€æ´»æ“´å±•
        cmd = [
            "code", 
            "--new-window",
            "--wait",
            f"--enable-extension={extension_name}",
            "/tmp/test-workspace"
        ]
        
        try:
            process = await asyncio.create_subprocess_exec(
                *cmd,
                stdout=asyncio.subprocess.PIPE,
                stderr=asyncio.subprocess.PIPE
            )
            
            # ç­‰å¾…é€²ç¨‹å•Ÿå‹•
            await asyncio.sleep(2)  # çµ¦VSCodeæ™‚é–“å•Ÿå‹•
            
            # æ¸¬é‡å¯¦éš›å•Ÿå‹•æ™‚é–“
            startup_time = (time.time() - start_time) * 1000  # è½‰æ›ç‚ºæ¯«ç§’
            
            # çµ‚æ­¢é€²ç¨‹
            process.terminate()
            await process.wait()
            
            # è©•ä¼°æ€§èƒ½ç­‰ç´š
            if startup_time < 100:
                benchmark = "excellent"
            elif startup_time < 300:
                benchmark = "good"
            elif startup_time < 1000:
                benchmark = "average"
            else:
                benchmark = "poor"
            
            return {
                "startup_time_ms": startup_time,
                "benchmark": benchmark,
                "measurement_timestamp": datetime.now().isoformat()
            }
            
        except Exception as e:
            return {
                "startup_time_ms": -1,
                "benchmark": "error",
                "error": str(e)
            }
```

#### **å…§å­˜ä½¿ç”¨ç›£æ§**
```python
async def _measure_memory_usage(self) -> Dict[str, Any]:
    """æ¸¬é‡å…§å­˜ä½¿ç”¨"""
    try:
        # ä½¿ç”¨psutilç›£æ§VSCodeé€²ç¨‹
        import psutil
        
        vscode_processes = []
        for proc in psutil.process_iter(['pid', 'name', 'memory_info']):
            if 'code' in proc.info['name'].lower():
                vscode_processes.append(proc)
        
        if vscode_processes:
            total_memory = sum(proc.info['memory_info'].rss for proc in vscode_processes)
            memory_mb = total_memory / (1024 * 1024)  # è½‰æ›ç‚ºMB
            
            # è©•ä¼°å…§å­˜ä½¿ç”¨ç­‰ç´š
            if memory_mb < 50:
                benchmark = "excellent"
            elif memory_mb < 150:
                benchmark = "good"
            elif memory_mb < 300:
                benchmark = "average"
            else:
                benchmark = "poor"
            
            return {
                "memory_usage_mb": memory_mb,
                "process_count": len(vscode_processes),
                "benchmark": benchmark
            }
        else:
            return {
                "memory_usage_mb": 0,
                "process_count": 0,
                "benchmark": "no_process"
            }
            
    except ImportError:
        return {
            "memory_usage_mb": -1,
            "benchmark": "psutil_not_available"
        }
    except Exception as e:
        return {
            "memory_usage_mb": -1,
            "benchmark": "error",
            "error": str(e)
        }
```

## ğŸ”„ **æ•¸æ“šæµè½‰å’Œç‹€æ…‹æ©Ÿ**

### **éƒ¨ç½²ç‹€æ…‹æ©Ÿ**
```
[æº–å‚™] â†’ [æ§‹å»º] â†’ [é©—è­‰] â†’ [éƒ¨ç½²] â†’ [å®‰è£] â†’ [å®Œæˆ]
   â†“        â†“        â†“        â†“        â†“        â†“
[éŒ¯èª¤] â† [éŒ¯èª¤] â† [éŒ¯èª¤] â† [éŒ¯èª¤] â† [éŒ¯èª¤] â† [éŒ¯èª¤]
   â†“
[å›æ»¾] â†’ [æ¸…ç†] â†’ [å¤±æ•—]
```

### **æ•¸æ“šè½‰æ›æµç¨‹**
```
æºä»£ç¢¼ â†’ npm build â†’ VSIXæ–‡ä»¶ â†’ base64ç·¨ç¢¼ â†’ HTTPå‚³è¼¸ â†’ 
base64è§£ç¢¼ â†’ VSIXæ–‡ä»¶ â†’ VSCodeå®‰è£ â†’ æ“´å±•æ¿€æ´»
```

## ğŸ“Š **é—œéµé…ç½®åƒæ•¸**

### **æ€§èƒ½èª¿å„ªåƒæ•¸**
```python
# è¶…æ™‚é…ç½®
deployment_timeout: int = 300      # éƒ¨ç½²ç¸½è¶…æ™‚æ™‚é–“
retry_attempts: int = 3            # é‡è©¦æ¬¡æ•¸
retry_delay: int = 30              # é‡è©¦é–“éš”

# æ–‡ä»¶å¤§å°é™åˆ¶
max_extension_size: int = 50 * 1024 * 1024  # 50MB

# ä¸¦ç™¼æ§åˆ¶
max_concurrent_deployments: int = 5  # æœ€å¤§ä¸¦ç™¼éƒ¨ç½²æ•¸
```

### **å®‰å…¨é…ç½®åƒæ•¸**
```python
# èªè­‰é…ç½®
enable_signature_verification: bool = True
api_key_length: int = 32

# æ–‡ä»¶é©—è­‰
checksum_algorithm: str = "sha256"
required_files: List[str] = ["package.json", "extension.vsixmanifest"]
```

é€™å€‹ä»£ç¢¼æ¶æ§‹æä¾›äº†å®Œæ•´çš„VSIXéƒ¨ç½²è§£æ±ºæ–¹æ¡ˆï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ“´å±•æ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚æ¯å€‹çµ„ä»¶éƒ½æœ‰æ˜ç¢ºçš„è·è²¬åˆ†å·¥ï¼Œé€šéç•°æ­¥è™•ç†å’ŒéŒ¯èª¤è™•ç†æ©Ÿåˆ¶ç¢ºä¿ç³»çµ±çš„ç©©å®šæ€§å’Œå¯é æ€§ã€‚

